# CRE Signal Engine — Premium Refinements (Final)

Refinements only. No new features. Optimize for: conversion to Pro, institutional positioning, clean backend enforcement, minimal engineering risk, long-term credibility.

---

## 1. Lifetime Scan Enforcement — Absolute Hardening

### Enforcement principles

- Lifetime limit applies **only to Free** users.
- **Pro** users bypass lifetime cap entirely.
- **Free** users have **no daily cap**.
- Lifetime cap must **block before any OpenAI calls**.
- Lifetime increment must happen **only after successful full scan commit**.
- **Reused scans must never increment.**

### Postgres function constraints

The increment function must:

- Be the **only path** that modifies `total_full_scans_used`.
- Be **SECURITY DEFINER**.
- Perform a **single atomic update**.
- **Return** the updated value.
- **Not** allow negative or manual adjustment.

### API behavior contract

When lifetime cap is reached, return **exactly**:

```json
{
  "code": "LIFETIME_LIMIT_REACHED",
  "used": 3,
  "limit": 3,
  "message": "Institutional features require Pro access."
}
```

- This shape must remain **stable across versions**.
- Client logic must key **only off `code`**.
- No variation.

---

## 2. Paywall Modal — Institutional Conversion Optimization

- Keep the copy **exactly as defined** (title, body, bullets, $99 line, primary/secondary CTAs).

### Add two refinements

**A. Subtle authority framing**

Under the bullets, add:

> "Used by underwriting teams evaluating institutional real estate."

No fake metrics. No logos. Just positioning.

**B. Behavioral reinforcement**

Add small line:

> "Your underwriting data remains intact."

Psychological removal of friction.

### Modal rules

- Trigger on **LIFETIME_LIMIT_REACHED**.
- Trigger on **PRO_REQUIRED_*** codes.
- **Do not** auto-close on background click.
- Maintain institutional tone.
- No animations. No flashy UX.

---

## 3. Pricing Page — Remove Softness

- The page **must not** mention “AI-powered”.
- **Do not say:** Smart, Intelligent, Fast, Instant.
- **Say:** Structured, Defensible, Institutional, Underwriting workflow.
- You are selling **risk control**, not automation.

---

## 4. PDF Export — Credibility Requirements

**PDF must include:**

- CRE Signal Risk Index™ **prominently**
- Risk tier badge
- Timestamp
- Prompt version
- Footer disclaimer

**Must not include:**

- No mention of OpenAI or model provider
- No “Generated by AI” language

This is underwriting infrastructure, not a chatbot.

**Error contract (free user):**

```json
{ "code": "PRO_REQUIRED_FOR_EXPORT" }
```

No additional data.

---

## 5. Risk Percentile Benchmarking — Credibility Guardrail

**Percentile calculation must exclude:**

- Incomplete scans
- Reused scans (if distinguishable; otherwise completed-only is sufficient)
- Null `risk_index_score`
- Cross-asset types (same `asset_type` only)

**Do not:**

- Attempt smoothing.
- Infer across small sample sizes.

**If `sample_size < 5`:**

Display **exactly:**

> "Limited benchmark data available."

Do **not** attempt fallback logic. This protects long-term credibility.

---

## 6. Scenario Comparison — Institutional Simplicity

**Comparison must:**

- Display **numeric delta** in risk index.
- Display **band change** (e.g. Moderate → Elevated).
- Display **counts** of risks added and removed.
- **Not** track severity-level changes.

**UI:**

- Feel like underwriting comparison, not Git diff.
- No colors beyond risk tier styling.

---

## 7. Portfolio Dashboard — Institutional Tone

- No heavy charts required.
- **Tables are acceptable** if: clean, minimal, professional.

**Sections only:**

- Distribution by Risk Tier
- Top 5 Highest Risk Deals
- Exposure by Asset Type
- Exposure by Market

**Do not add:**

- Performance metrics
- Projections

This is **exposure overview only**.

---

## 8. Workspace UX — Institutional Behavior

- **Do not hide** locked features.
- Show **disabled state** with **subtle lock icon**.
- **No** tooltip sarcasm. **No** “Upgrade now!” pop-ups.
- Use: **"Pro access required."** Keep it calm.

---

## 9. Clean Gating Architecture — Non-Negotiable

- All gating must be enforced **server-side**.
- **Never** rely on: disabled button only, hidden UI, client-only plan checks.

**Every gated API must return structured error codes:**

- `PRO_REQUIRED_FOR_EXPORT`
- `PRO_REQUIRED_FOR_INVITE`
- `PRO_REQUIRED_FOR_PERCENTILE`
- `PRO_REQUIRED_FOR_SCENARIO`
- `PRO_REQUIRED_FOR_PORTFOLIO`
- `LIFETIME_LIMIT_REACHED`

**Client:** Switch on `code`. No string matching (use literal code comparison).

---

## 10. Institutional Tone Audit — Hard Enforcement

**Across entire app, remove:**

- “AI-powered”
- “Magic”
- “Instant”
- “Smart”
- “Powered by OpenAI”
- Startup-style marketing copy

**Replace with:**

- Underwriting infrastructure
- Structured risk intelligence
- Institutional workflow
- Defensible analysis

**Tone target:** Mid-market PE real estate firm. Not YC startup demo.

---

## 11. Revenue-First Safeguards — Stripe Hardening

**Webhook must:**

- **Immediately** update `profiles.role` on:
  - `checkout.session.completed`
  - `customer.subscription.updated`
- **No** async job. **No** delay. **No** polling.

**After successful payment:**

- User must have **Pro access immediately** on next request.

**Billing page must show:**

- Plan: Free / Pro
- Clear status label.

---

## 12. Race Safety Confirmation Requirement

After implementation, **explicitly confirm:**

1. Lifetime increment function is the **only** mutation path for `total_full_scans_used`.
2. It is called **once** per successful full scan.
3. It is **not** called on reused scans.
4. It **cannot** double-increment due to concurrent requests.
5. Service role **does not** perform manual `UPDATE` on `profiles` for this field.

This must be verified.

---

## 13. Deliverable Format (Required)

After implementation, return **structured output only** (no summaries, no commentary):

1. **File-level code changes** (brief)
2. **All migrations created**
3. **All new endpoints**
4. **Gated endpoint list** with associated error codes
5. **Confirmation of race safety**
6. **Confirmation of Stripe webhook instant role update**

No summaries. No commentary. Just structured output.
